#+title:  Tooling configuration for brand new Python projects
#+author: Vedang Manerikar
#+email: vedang@unravel.tech
#+language: en
#+options: ':t toc:nil num:nil author:t email:t

* Quickstart

1. Copy over the =Makefile= to your Python project.
2. Run =make help= to see what you can do.

[ A short thread on what using Metapy looks like: <link> (<date>) ]

* Table of Contents :TOC:
- [[#quickstart][Quickstart]]
- [[#introduction][Introduction]]
- [[#the-phony-section-of-the-makefile][The PHONY section of the Makefile]]
- [[#the-common-variables-section-of-the-makefile][The common variables section of the Makefile]]
- [[#set-bash-as-the-shell-for-executing-commands][Set Bash as the shell for executing commands]]
- [[#the-default-goal-section-of-the-makefile][The default goal section of the Makefile]]
- [[#the-help-target-to-explain-what-you-can-do-with-the-makefile][The help target to explain what you can do with the Makefile]]
- [[#the-environment-setup-section][The Environment Setup section]]
  - [[#the-env-and-env-sample-section-of-the-makefile][The .env and .env.sample section of the Makefile]]
  - [[#the-pyprojecttoml-section-of-the-makefile][The pyproject.toml section of the Makefile]]
  - [[#the-virtual-environment-section-of-the-makefile][The Virtual Environment section of the Makefile]]
- [[#the-development-tools-installation-section][The Development Tools Installation section]]
  - [[#the-ruff-section-of-the-makefile][The Ruff section of the Makefile]]
  - [[#the-pytest-section-of-the-makefile][The Pytest section of the Makefile]]
  - [[#the-ty-section-of-the-makefile][The Ty section of the Makefile]]
  - [[#the-basedpyright-section-of-the-makefile][The BasedPyright section of the Makefile]]
  - [[#the-tagref-section-of-the-makefile][The Tagref section of the Makefile]]
  - [[#the-bandit-section-of-the-makefile][The Bandit section of the Makefile]]
  - [[#the-git-hooks-section-of-the-makefile][The Git Hooks section of the Makefile]]
  - [[#the-configuration-files-section-of-the-makefile][The Configuration Files section of the Makefile]]
- [[#the-code-quality-section][The Code Quality section]]
  - [[#the-checking-section-of-the-makefile][The Checking section of the Makefile]]
  - [[#the-formatting-section-of-the-makefile][The Formatting section of the Makefile]]
- [[#the-testing-section][The Testing section]]
- [[#the-build-section][The Build section]]
  - [[#the-uv-build-section-of-the-makefile][The UV Build section of the Makefile]]
  - [[#the-docker-build-section-of-the-makefile][The Docker Build section of the Makefile]]
- [[#the-infrastructure-section][The Infrastructure section]]
  - [[#the-docker-compose-section-of-the-makefile][The Docker Compose section of the Makefile]]
  - [[#the-database-migration-section-of-the-makefile][The Database Migration section of the Makefile]]
  - [[#the-fastapi-server-section-of-the-makefile][The FastAPI Server section of the Makefile]]
- [[#the-deployment-section][The Deployment section]]
  - [[#the-flyio-deployment-section-of-the-makefile][The Fly.io Deployment section of the Makefile]]
  - [[#the-rollback-section-of-the-makefile][The Rollback section of the Makefile]]
  - [[#the-build-only-deployment-section-of-the-makefile][The Build-only Deployment section of the Makefile]]
- [[#the-maintenance-section][The Maintenance section]]
  - [[#the-dependency-upgrade-section-of-the-makefile][The Dependency Upgrade section of the Makefile]]
  - [[#the-cleaning-section-of-the-makefile][The Cleaning section of the Makefile]]

* Introduction
:PROPERTIES:
:CUSTOM_ID: h:CDD118FE-59DE-4B59-B919-22DF82087BA1
:CREATED:  [2024-12-28 Sat 11:25]
:END:

Whenever I start a new Python project, I run through a series of
steps to standardize the project's developer experience. This project
is an attempt to short-circuit that, and also to note all the steps
down for my own reference in the future.

To make a change to Metapy's Makefile, edit this file and then
type =C-c C-v C-t= (=M-x org-babel-tangle=) to publish the changes.

* The PHONY section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:207937CB-7D6B-4EA3-AF7A-BE36057F8D89
:CREATED:  [2024-12-28 Sat 11:30]
:END:

A target in a Makefile is meant to be an actual file that the
"execution" of the target creates. Sometimes, we want "actions" as
target -- think =make check= or =make build=, we do not expect a file
called ~check~ or a file called ~build~ to be created. We call these
targets as phony targets, and informing ~make~ helps it avoid checking
for the existence of these files.

Our PHONY targets are as follows:

1. *Environment Setup* (You only need to do this once)
   - =venv= (Creating virtual environment and .env file. See: [[#h:944B86CB-099C-47F9-9F91-DB446EF68012][The Virtual Environment section of the Makefile]])
   - =install-dev-tools= (Installing all development tools. See: [[#h:1438EEBB-FA57-476C-A06E-D4A61EDF2C17][The Development Tools Installation section]])
2. *Code Quality*
   - =check= (Running all quality checks. See: [[#h:7AF49050-665C-4BF6-BC19-97B553F7D0B4][The Checking section of the Makefile]])
   - =format= (Formatting code with ruff. See: [[#h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD][The Formatting section of the Makefile]])
3. *Testing our Python project*
   - =test= (Running unit tests. See: [[#h:CD7913EA-0DCC-4388-BDF5-9DA5AB0C3531][The Testing section]])
   - =test-llm= (Running LLM tests)
   - =test-integration= (Running integration tests)
4. *Building our Python project*
   - =build= (Building deployment artifact. See: [[#h:9EF38A44-B1D5-4357-9DEA-A4BD91202FE5][The UV Build section of the Makefile]])
   - =docker-build= (Building Docker image. See: [[#h:B12DAE81-0591-4E36-B8BA-A73B293FB783][The Docker Build section of the Makefile]])
   - =docker-compose-build= (Building local infrastructure)
5. *Running Infrastructure*
   - =up= (Starting local infrastructure. See: [[#h:287495BE-C413-48D2-86CC-9741B7E3E7E0][The Docker Compose section of the Makefile]])
   - =down= (Stopping local infrastructure)
   - =migrate= (Running database migrations. See: [[#h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E][The Database Migration section of the Makefile]])
   - =server= (Running FastAPI server. See: [[#h:16E6BE64-E940-45CD-AEE7-82D197E6B2DA][The FastAPI Server section of the Makefile]])
6. *Deploying our Python project to Production*
   - =deploy= (Deploying to production with backup. See: [[#h:F4650D06-3125-4FC6-A426-A4B257C86B25][The Fly.io Deployment section of the Makefile]])
   - =rollback= (Rolling back to previous version. See: [[#h:557E00DD-D217-468E-9F20-FE4FE4C049BE][The Rollback section of the Makefile]])
   - =prepare= (Building and uploading image. See: [[#h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD][The Build-only Deployment section of the Makefile]])
7. *Maintenance*
   - =upgrade-libs= (Upgrading dependencies. See: [[#h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E][The Dependency Upgrade section of the Makefile]])
   - =clean= (Cleaning artifacts. See: [[#h:DDEC523F-F4A5-4506-A1DA-3290336D6527][The Cleaning section of the Makefile]])

PHONY targets are declared right above the target itself, for easy maintainability and readability