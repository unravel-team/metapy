#+title:  Tooling configuration for brand new Python projects
#+author: Vedang Manerikar
#+email: vedang@unravel.tech
#+language: en
#+options: ':t toc:nil num:nil author:t email:t

* Quickstart

1. Copy over the =Makefile= to your Python project.
2. Run =make help= to see what you can do.

[ A short thread on what using Metapy looks like: <link> (<date>) ]

* Table of Contents :TOC:
- [[#quickstart][Quickstart]]
- [[#introduction][Introduction]]
- [[#the-phony-section-of-the-makefile][The PHONY section of the Makefile]]
- [[#the-common-variables-section-of-the-makefile][The common variables section of the Makefile]]
- [[#set-bash-as-the-shell-for-executing-commands][Set Bash as the shell for executing commands]]
- [[#the-default-goal-section-of-the-makefile][The default goal section of the Makefile]]
- [[#the-help-target-to-explain-what-you-can-do-with-the-makefile][The help target to explain what you can do with the Makefile]]
- [[#the-environment-setup-section][The Environment Setup section]]
  - [[#the-env-and-env-sample-section-of-the-makefile][The .env and .env.sample section of the Makefile]]
  - [[#the-pyprojecttoml-section-of-the-makefile][The pyproject.toml section of the Makefile]]
  - [[#the-virtual-environment-section-of-the-makefile][The Virtual Environment section of the Makefile]]
- [[#the-development-tools-installation-section][The Development Tools Installation section]]
  - [[#the-ruff-section-of-the-makefile][The Ruff section of the Makefile]]
  - [[#the-pytest-section-of-the-makefile][The Pytest section of the Makefile]]
  - [[#the-ty-section-of-the-makefile][The Ty section of the Makefile]]
  - [[#the-basedpyright-section-of-the-makefile][The BasedPyright section of the Makefile]]
  - [[#the-tagref-section-of-the-makefile][The Tagref section of the Makefile]]
  - [[#the-bandit-section-of-the-makefile][The Bandit section of the Makefile]]
  - [[#the-git-hooks-section-of-the-makefile][The Git Hooks section of the Makefile]]
  - [[#the-configuration-files-section-of-the-makefile][The Configuration Files section of the Makefile]]
- [[#the-code-quality-section][The Code Quality section]]
  - [[#the-checking-section-of-the-makefile][The Checking section of the Makefile]]
  - [[#the-formatting-section-of-the-makefile][The Formatting section of the Makefile]]
- [[#the-testing-section][The Testing section]]
- [[#the-build-section][The Build section]]
  - [[#the-uv-build-section-of-the-makefile][The UV Build section of the Makefile]]
  - [[#the-docker-build-section-of-the-makefile][The Docker Build section of the Makefile]]
- [[#the-infrastructure-section][The Infrastructure section]]
  - [[#the-docker-compose-section-of-the-makefile][The Docker Compose section of the Makefile]]
  - [[#the-database-migration-section-of-the-makefile][The Database Migration section of the Makefile]]
  - [[#the-fastapi-server-section-of-the-makefile][The FastAPI Server section of the Makefile]]
- [[#the-deployment-section][The Deployment section]]
  - [[#the-flyio-deployment-section-of-the-makefile][The Fly.io Deployment section of the Makefile]]
  - [[#the-rollback-section-of-the-makefile][The Rollback section of the Makefile]]
  - [[#the-build-only-deployment-section-of-the-makefile][The Build-only Deployment section of the Makefile]]
- [[#the-maintenance-section][The Maintenance section]]
  - [[#the-dependency-upgrade-section-of-the-makefile][The Dependency Upgrade section of the Makefile]]
  - [[#the-cleaning-section-of-the-makefile][The Cleaning section of the Makefile]]

* Introduction
:PROPERTIES:
:CUSTOM_ID: h:CDD118FE-59DE-4B59-B919-22DF82087BA1
:CREATED:  [2024-12-28 Sat 11:25]
:END:

Whenever I start a new Python project, I run through a series of
steps to standardize the project's developer experience. This project
is an attempt to short-circuit that, and also to note all the steps
down for my own reference in the future.

To make a change to Metapy's Makefile, edit this file and then
type =C-c C-v C-t= (=M-x org-babel-tangle=) to publish the changes.

* The PHONY section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:207937CB-7D6B-4EA3-AF7A-BE36057F8D89
:CREATED:  [2024-12-28 Sat 11:30]
:END:

A target in a Makefile is meant to be an actual file that the
"execution" of the target creates. Sometimes, we want "actions" as
target -- think =make check= or =make build=, we do not expect a file
called ~check~ or a file called ~build~ to be created. We call these
targets as phony targets, and informing ~make~ helps it avoid checking
for the existence of these files.

Our PHONY targets are as follows:

1. *Environment Setup* (You only need to do this once)
   - =venv= (Creating virtual environment and .env file. See: [[#h:944B86CB-099C-47F9-9F91-DB446EF68012][The Virtual Environment section of the Makefile]])
   - =install-dev-tools= (Installing all development tools. See: [[#h:1438EEBB-FA57-476C-A06E-D4A61EDF2C17][The Development Tools Installation section]])
2. *Code Quality*
   - =check= (Running all quality checks. See: [[#h:7AF49050-665C-4BF6-BC19-97B553F7D0B4][The Checking section of the Makefile]])
   - =format= (Formatting code with ruff. See: [[#h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD][The Formatting section of the Makefile]])
3. *Testing our Python project*
   - =test= (Running unit tests. See: [[#h:CD7913EA-0DCC-4388-BDF5-9DA5AB0C3531][The Testing section]])
   - =test-llm= (Running LLM tests)
   - =test-integration= (Running integration tests)
4. *Building our Python project*
   - =build= (Building deployment artifact. See: [[#h:9EF38A44-B1D5-4357-9DEA-A4BD91202FE5][The UV Build section of the Makefile]])
   - =docker-build= (Building Docker image. See: [[#h:B12DAE81-0591-4E36-B8BA-A73B293FB783][The Docker Build section of the Makefile]])
   - =docker-compose-build= (Building local infrastructure)
5. *Running Infrastructure*
   - =up= (Starting local infrastructure. See: [[#h:287495BE-C413-48D2-86CC-9741B7E3E7E0][The Docker Compose section of the Makefile]])
   - =down= (Stopping local infrastructure)
   - =migrate= (Running database migrations. See: [[#h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E][The Database Migration section of the Makefile]])
   - =server= (Running FastAPI server. See: [[#h:16E6BE64-E940-45CD-AEE7-82D197E6B2DA][The FastAPI Server section of the Makefile]])
6. *Deploying our Python project to Production*
   - =deploy= (Deploying to production with backup. See: [[#h:F4650D06-3125-4FC6-A426-A4B257C86B25][The Fly.io Deployment section of the Makefile]])
   - =rollback= (Rolling back to previous version. See: [[#h:557E00DD-D217-468E-9F20-FE4FE4C049BE][The Rollback section of the Makefile]])
   - =prepare= (Building and uploading image. See: [[#h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD][The Build-only Deployment section of the Makefile]])
7. *Maintenance*
   - =upgrade-libs= (Upgrading dependencies. See: [[#h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E][The Dependency Upgrade section of the Makefile]])
   - =clean= (Cleaning artifacts. See: [[#h:DDEC523F-F4A5-4506-A1DA-3290336D6527][The Cleaning section of the Makefile]])

PHONY targets are declared right above the target itself, for easy maintainability and readability

* The common variables section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:B3833E1E-F328-4DDB-B5CD-31086232DEE2
:CREATED:  [2024-12-28 Sat 11:53]
:END:

These are variables we use in some of the other =Makefile= targets.
You can ignore them for now and we'll review them when we use them.

#+begin_src makefile-bsdmake :tangle "Makefile"
  HOME := $(shell echo $$HOME)
  HERE := $(shell echo $$PWD)
#+end_src

* Set Bash as the shell for executing commands
:PROPERTIES:
:CUSTOM_ID: h:06956487-A480-43D1-94EC-B9148CE6F2D6
:CREATED:  [2024-12-28 Sat 12:04]
:END:

#+begin_src makefile-bsdmake :tangle "Makefile"
  # Set bash instead of sh for the @if [[ conditions,
  # and use the usual safety flags:
  SHELL = /bin/bash -Eeu
#+end_src

* The default goal section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:FA6CC44F-CA8C-4E8B-8613-233C00F5F7EA
:CREATED:  [2024-12-28 Sat 11:55]
:END:

The =.DEFAULT_GOAL= is what runs when we only run the ~make~ command
with no directive. In our case, we want this to print the help options
and exit, so that the user has a clear idea of what is possible with
this Makefile.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .DEFAULT_GOAL := help
#+end_src

* The help target to explain what you can do with the Makefile
:PROPERTIES:
:CUSTOM_ID: h:F4650D06-3125-4FC6-A426-A4B257C86B25
:CREATED:  [2025-01-30 Thu 14:19]
:END:

Here, we use ~awk~ to filter out all the targets which have a
doc-string. This is the "public API" of the Makefile, so to speak.

=/^[a-zA-Z0-9_-]+:.*##/= is a pattern that matches lines starting with
a target name (letters, numbers, underscores, or hyphens) followed by
a colon, followed by ~##~ somewhere in the line. This finds Makefile
target definitions.

In the print command:
- =%-25s= formats the target name left-aligned in 25 characters
- =substr($$1, 1, length($$1)-1)= takes the target name (first field)
  without the trailing colon
- =substr($$0, index($$0,"##")+3)= extracts everything after ## (the
  comment)

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: help
  help:    ## A brief listing of all available commands
  	@awk '/^[a-zA-Z0-9_-]+:.*##/ { \
  		printf "%-25s # %s\n", \
  		substr($$1, 1, length($$1)-1), \
  		substr($$0, index($$0,"##")+3) \
  	}' $(MAKEFILE_LIST)
#+end_src

* The Environment Setup section
:PROPERTIES:
:CUSTOM_ID: h:1438EEBB-FA57-476C-A06E-D4A61EDF2C17
:CREATED:  [2025-04-20 Sun 19:40]
:END:

In this section, we set up the basic environment needed for a Python
project. This includes creating the necessary configuration files and
directory structure.

** The .env and .env.sample section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:DDEC523F-F4A5-4506-A1DA-3290336D6527
:CREATED:  [2025-01-03 Fri 21:22]
:END:

Environment variables are crucial for Python applications. We create a
=.env.sample= file as a template, and then copy it to =.env= if it
doesn't exist. This follows 12-factor app principles.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .env.sample:
  	touch .env.sample

  .env: .env.sample    ## Copy .env.sample to .env if .env doesn't exist
  	@if [ ! -f .env ]; then \
  		echo "Creating .env from .env.sample..."; \
  		cp .env.sample .env; \
  		echo "✓ .env created. Please edit it with your actual values."; \
  	else \
  		echo ".env already exists, skipping..."; \
  	fi
#+end_src

** The pyproject.toml section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD
:CREATED:  [2025-01-03 Fri 21:18]
:END:

The =pyproject.toml= file is the modern standard for Python project
configuration. We create a basic template using hatchling as the build
backend, which is simple and reliable.

#+begin_src makefile-bsdmake :tangle "Makefile"
  pyproject.toml:
  	@if [ ! -f pyproject.toml ]; then \
  		echo "Creating pyproject.toml..."; \
  		echo '[build-system]' > pyproject.toml; \
  		echo 'requires = ["hatchling"]' >> pyproject.toml; \
  		echo 'build-backend = "hatchling.build"' >> pyproject.toml; \
  		echo '' >> pyproject.toml; \
  		echo '[project]' >> pyproject.toml; \
  		echo 'name = "metapy"' >> pyproject.toml; \
  		echo 'version = "0.1.0"' >> pyproject.toml; \
  		echo 'description = ""' >> pyproject.toml; \
  		echo 'authors = []' >> pyproject.toml; \
  		echo 'keywords = []' >> pyproject.toml; \
  		echo 'packages = [{include="src"}]' >> pyproject.toml; \
  	    echo 'requires-python = ">=3.14.0"' >> pyproject.toml; \
  		echo '' >> pyproject.toml; \
  	fi
#+end_src

** The Virtual Environment section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:944B86CB-099C-47F9-9F91-DB446EF68012
:CREATED:  [2024-12-28 Sat 16:40]
:END:

We use UV for fast and reliable Python package management. The =venv=
target creates the virtual environment, sets up the basic directory
structure, and installs dependencies.

#+begin_src makefile-bsdmake :tangle "Makefile"
  tests:
  	mkdir tests

  src:
  	mkdir -p src/metapy && touch src/metapy/__init__.py

  .venv: pyproject.toml tests src
  	uv venv
  	uv lock
  	uv sync --locked --no-cache

  .PHONY: venv
  venv: .venv .env    ## Create the .venv and the .env files
  	@echo "Virtual environment created at .venv/"
#+end_src

* The Development Tools Installation section
:PROPERTIES:
:CUSTOM_ID: h:72304956-2E82-4888-9709-8E69AA6D2A56
:CREATED:  [2025-04-20 Sun 18:52]
:END:

This section installs all the development tools needed for a modern
Python project. Each tool is installed separately so you can pick and
choose what you need.

** The Ruff section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:557E00DD-D217-468E-9F20-FE4FE4C049BE
:CREATED:  [2025-01-03 Fri 21:13]
:END:

~ruff~ is an extremely fast Python linter and formatter, written in
Rust. It combines the functionality of many separate tools into one
fast package.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: install-ruff
  install-ruff: pyproject.toml
  	uv add ruff --group dev
  	@if ! grep -q "\[tool.ruff.lint\]" pyproject.toml; then \
  		echo '' >> pyproject.toml; \
  		echo '[tool.ruff.lint]' >> pyproject.toml; \
  		echo 'select = [' >> pyproject.toml; \
  		echo '    # pycodestyle' >> pyproject.toml; \
  		echo '    "E",' >> pyproject.toml; \
  		echo '    # Pyflakes' >> pyproject.toml; \
  		echo '    "F",' >> pyproject.toml; \
  		echo '    # pyupgrade' >> pyproject.toml; \
  		echo '    "UP",' >> pyproject.toml; \
  		echo '    # flake8-bugbear' >> pyproject.toml; \
  		echo '    "B",' >> pyproject.toml; \
  		echo '    # flake8-simplify' >> pyproject.toml; \
  		echo '    "SIM",' >> pyproject.toml; \
  		echo '    # isort' >> pyproject.toml; \
  		echo '    "I",' >> pyproject.toml; \
  		echo ']' >> pyproject.toml; \
  		echo 'ignore = ["E501"]' >> pyproject.toml; \
  	fi
#+end_src

** The Pytest section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD
:CREATED:  [2025-01-03 Fri 21:18]
:END:

~pytest~ is the de facto standard testing framework for Python. We
configure it with useful defaults for async testing and logging.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: install-pytest
  install-pytest: pyproject.toml
  	uv add pytest pytest-asyncio --group dev
  	@if ! grep -q "\[tool.pytest.ini_options\]" pyproject.toml; then \
  		echo '' >> pyproject.toml; \
  		echo '[tool.pytest.ini_options]' >> pyproject.toml; \
  		echo 'testpaths = ["tests"]' >> pyproject.toml; \
  		echo 'addopts = "-v --tb=short"' >> pyproject.toml; \
  		echo 'asyncio_mode = "auto"' >> pyproject.toml; \
  		echo 'log_cli = true' >> pyproject.toml; \
  		echo 'log_cli_level = "INFO"' >> pyproject.toml; \
  		echo 'log_cli_format = "%(asctime)s [%(levelname)8s] %(message)s (%(filename)s:%(lineno)s)"' >> pyproject.toml; \
  		echo 'asyncio_default_fixture_loop_scope = "function"' >> pyproject.toml; \
  	fi
#+end_src

** The Ty section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:9EF38A44-B1D5-4357-9DEA-A4BD91202FE5
:CREATED:  [2025-01-03 Fri 21:40]
:END:

~ty~ is a simple type checker that complements more complex type
checkers like mypy or pyright.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: install-ty
  install-ty:
  	uv add ty --group dev
#+end_src

** The BasedPyright section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:B12DAE81-0591-4E36-B8BA-A73B293FB783
:CREATED:  [2025-01-03 Fri 21:38]
:END:

~basedpyright~ is a fork of Pyright with more sensible defaults and
better performance for large codebases.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: install-basedpyright
  install-basedpyright: pyproject.toml
  	uv add basedpyright --group dev
  	@if ! grep -q "\[tool.basedpyright\]" pyproject.toml; then \
  		echo '' >> pyproject.toml; \
  		echo '[tool.basedpyright]' >> pyproject.toml; \
  		echo 'reportAny = false' >> pyproject.toml; \
  		echo 'reportExplicitAny = false' >> pyproject.toml; \
  		echo 'reportUnknownMemberType = false' >> pyproject.toml; \
  		echo 'reportUnknownImport = false      # [tag: reenable_type_check_after_async_work]' >> pyproject.toml; \
  		echo 'reportUnknownArgumentType = false' >> pyproject.toml; \
  		echo 'reportUnknownVariableType = false' >> pyproject.toml; \
  		echo 'reportUnknownLambdaType = false' >> pyproject.toml; \
  	fi
#+end_src

** The Tagref section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:287495BE-C413-48D2-86CC-9741B7E3E7E0
:CREATED:  [2025-01-03 Fri 21:39]
:END:

~tagref~ is a tool for checking that references to code (like
[tag:example]) actually exist in the codebase.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: install-tagref
  install-tagref:
  	@if ! command -v tagref >/dev/null 2>&1; then \
  		echo "tagref executable not found. Please install it from https://github.com/stepchowfun/tagref?tab=readme-ov-file#installation-instructions"; \
  		exit 1; \
  	fi
#+end_src

** The Bandit section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E
:CREATED:  [2025-01-03 Fri 21:35]
:END:

~bandit~ is a security linter designed to find common security issues
in Python code.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: install-bandit
  install-bandit:
  	uv tool install bandit
#+end_src

** The Git Hooks section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:CD7913EA-0DCC-4388-BDF5-9DA5AB0C3531
:CREATED:  [2025-01-03 Fri 21:31]
:END:

Git hooks ensure code quality before commits by running checks
automatically.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .git/hooks/pre-push:
  	@echo "Setting up Git hooks..."
  	@cp dev_tools/hooks/pre-push .git/hooks/pre-push
  	@chmod +x .git/hooks/pre-push
  	@echo "✅ Git hooks installed successfully!"
  	@echo "The pre-push hook will run make check, make format, and make test before each push."

  .PHONY: install-hooks
  install-hooks: .git/hooks/pre-push
#+end_src

** The Configuration Files section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:F9F04893-395F-4E15-A5FA-BE955ADB0A00
:CREATED:  [2025-04-20 Sun 20:12]
:END:

These configuration files are needed for various tools to work properly
with the project.

#+begin_src makefile-bsdmake :tangle "Makefile"
  AGENTS.md:
  	@echo "Download the CONVENTIONS.md file from the [[https://github.com/unravel-team/metapy][metapy]] project, then symlink it to AGENTS.md and CLAUDE.md"

  .aider.conf.yml:
  	@echo "Download the .aider.conf.yml file from the [[https://github.com/unravel-team/metapy][metapy]] project"

  .gitignore:
  	@echo "Download the .gitignore file from the [[https://github.com/unravel-team/metapy][metapy]] project"

  .PHONY: install-dev-tools
  install-dev-tools: install-ruff install-pytest install-ty  install-basedpyright install-tagref install-bandit install-hooks AGENTS.md .aider.conf.yml .gitignore    ## Install all development tools (Ruff, Pytest, Ty, Tagref, Bandit, Hooks)
#+end_src

* The Code Quality section
:PROPERTIES:
:CUSTOM_ID: h:B423079B-E66C-4DEE-AC9E-8ED12225EB43
:CREATED:  [2025-01-03 Fri 21:27]
:END:

This section contains all the targets for checking and formatting code
to ensure it meets our quality standards.

** The Checking section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:7AF49050-665C-4BF6-BC19-97B553F7D0B4
:CREATED:  [2025-01-03 Fri 22:17]
:END:

This section runs multiple checks in order from fastest to slowest:
- UV lock check (verifies dependency consistency)
- Ruff linting (fast Python linting)
- Tagref (checks code references)
- Ty type checking (simple type checker)
- Bandit security analysis
- BasedPyright type checking (comprehensive type checking)

Run the command =make check= to see if your code is compliant.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: check-bandit
  check-bandit:
  	bandit -q -ii -lll -c .bandit.yml -r src/

  .PHONY: check-tagref
  check-tagref: install-tagref
  	tagref

  .PHONY: check-uv
  check-uv:
  	uv lock --check

  .PHONY: check-ruff
  check-ruff:
  	uv run ruff check -n src tests

  .PHONY: check-ty
  check-ty:
  	uv run ty check src tests

  .PHONY: check-basedpyright
  check-basedpyright:
  	uv run basedpyright src tests

  .PHONY: check
  check: check-uv check-ruff check-tagref check-ty check-bandit check-basedpyright    ## Check that the code is well linted, well typed, well documented. Fast checks first, slow later
  	@echo "All checks passed!"
#+end_src

** The Formatting section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD
:CREATED:  [2025-01-03 Fri 21:18]
:END:

~ruff~ is used for both linting and formatting. The =format= target
first fixes any auto-fixable linting issues, then formats the code.

Run the command =make format= to format all your Python source files.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: format
  format:  ## Format the code using ruff
  	uv run ruff check -n --fix
  	uv run ruff format

  .PHONY: megalinter
  megalinter:
  	docker run --rm -v "$(HERE):/tmp/lint" oxsecurity/megalinter:v8
#+end_src

* The Testing section
:PROPERTIES:
:CUSTOM_ID: h:CD7913EA-0DCC-4388-BDF5-9DA5AB0C3531
:CREATED:  [2025-01-03 Fri 21:31]
:END:

We use ~pytest~ for testing with markers to categorize different types
of tests. This allows us to run specific test suites depending on what
we want to validate.

The test categories are:
- =unit=: Standard unit tests that don't require external services
- =llm=: Tests that interact with LLM APIs (can be slow and expensive)
- =integration=: Tests that require external infrastructure

Run the command =make test= for unit tests, =make test-llm= for LLM
tests, or =make test-integration= for integration tests.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: test
  test:    ## Run only the unit tests
  	uv run pytest -m "unit"

  .PHONY: test-llm
  test-llm:    ## Run only the llm tests
  	uv run pytest -m "llm"

  .PHONY: test-integration
  test-integration:    ## Run only the integration tests
  	uv run pytest -m "integration"
#+end_src

* The Build section
:PROPERTIES:
:CUSTOM_ID: h:9EF38A44-B1D5-4357-9DEA-A4BD91202FE5
:CREATED:  [2025-01-03 Fri 21:40]
:END:

This section contains targets for building the project in different
formats - from Python packages to Docker images.

** The UV Build section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:B12DAE81-0591-4E36-B8BA-A73B293FB783
:CREATED:  [2025-01-03 Fri 21:38]
:END:

The ~build~ target creates a Python package using UV. It runs the
quality checks first to ensure we're not building broken code.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: build
  build: check     ## Build the deployment artifact
  	uv build
#+end_src

** The Docker Build section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:287495BE-C413-48D2-86CC-9741B7E3E7E0
:CREATED:  [2025-01-03 Fri 21:39]
:END:

Docker builds create container images for deployment. We tag images
with both the =latest= tag and the git commit hash for traceability.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: docker-build
  docker-build:   ## Build the FastAPI server Dockerfile
  	docker build -f Dockerfile -t metapy:latest -t metapy:$$(git rev-parse --short HEAD) .

  .PHONY: docker-compose-build
  docker-compose-build:  ## Build all the local infra (docker-compose)
  	docker compose build
#+end_src

* The Infrastructure section
:PROPERTIES:
:CUSTOM_ID: h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E
:CREATED:  [2025-01-03 Fri 21:35]
:END:

This section manages the local development infrastructure using
Docker Compose, including databases, message queues, and other services
needed for development.

** The Docker Compose section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:CD7913EA-0DCC-4388-BDF5-9DA5AB0C3531
:CREATED:  [2025-01-03 Fri 21:31]
:END:

Docker Compose is used to orchestrate local development services.
The =up= target starts all services, while =down= stops them.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: up
  up:   ## Bring up all the local infra (docker-compose) and synthetic data
  	docker compose up

  .PHONY: logs
  logs:
  	docker compose logs

  .PHONY: down
  down:       ## Bring down all the local infra (docker-compose)
  	docker compose down

  .PHONY: down-clean
  down-clean:  ## Bring down all the local infra and delete volumes
  	@echo "Warning: Deleting volumes will lead to data loss. You will start from scratch and this may introduce bugs (e.g., if your code does not work with existing data in postgres)."
  	@read -p "Are you sure you want to proceed? (yes/no): " confirm; \
  	if [ "$$confirm" = "yes" ]; then \
  		docker compose down -v; \
  		echo "Volumes deleted."; \
  	else \
  		echo "Aborted."; \
  	fi
#+end_src

** The Database Migration section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD
:CREATED:  [2025-01-03 Fri 21:18]
:END:

We use Alembic for database migrations. The =migrate= target runs all
pending migrations to bring the database schema up to date.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: migrate
  migrate:    ## Run Alembic database migrations
  	uv run python -m alembic upgrade head
#+end_src

** The FastAPI Server section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:9EF38A44-B1D5-4357-9DEA-A4BD91202FE5
:CREATED:  [2025-01-03 Fri 21:40]
:END:

The =server= target runs the FastAPI application locally with tracing
enabled for observability.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: server
  server:    ## Run the FastAPI server locally
  	ENABLE_TRACING=true uv run -m unravel.fastapi.main
#+end_src