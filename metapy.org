#+title:  Tooling configuration for brand new Python projects
#+author: Vedang Manerikar
#+email: vedang@unravel.tech
#+language: en
#+options: ':t toc:nil num:nil author:t email:t

* Quickstart

1. Copy over the =Makefile= to your Python project.
2. Run =make help= to see what you can do.

[ A short thread on what using Metapy looks like: <link> (<date>) ]

* Table of Contents :TOC:
- [[#quickstart][Quickstart]]
- [[#introduction][Introduction]]
- [[#the-phony-section-of-the-makefile][The PHONY section of the Makefile]]
- [[#the-common-variables-section-of-the-makefile][The common variables section of the Makefile]]
- [[#set-bash-as-the-shell-for-executing-commands][Set Bash as the shell for executing commands]]
- [[#the-default-goal-section-of-the-makefile][The default goal section of the Makefile]]
- [[#the-help-target-to-explain-what-you-can-do-with-the-makefile][The help target to explain what you can do with the Makefile]]
- [[#the-environment-setup-section][The Environment Setup section]]
  - [[#the-env-and-env-sample-section-of-the-makefile][The .env and .env.sample section of the Makefile]]
  - [[#the-pyprojecttoml-section-of-the-makefile][The pyproject.toml section of the Makefile]]
  - [[#the-virtual-environment-section-of-the-makefile][The Virtual Environment section of the Makefile]]
- [[#the-development-tools-installation-section][The Development Tools Installation section]]
  - [[#the-ruff-section-of-the-makefile][The Ruff section of the Makefile]]
  - [[#the-pytest-section-of-the-makefile][The Pytest section of the Makefile]]
  - [[#the-ty-section-of-the-makefile][The Ty section of the Makefile]]
  - [[#the-basedpyright-section-of-the-makefile][The BasedPyright section of the Makefile]]
  - [[#the-tagref-section-of-the-makefile][The Tagref section of the Makefile]]
  - [[#the-bandit-section-of-the-makefile][The Bandit section of the Makefile]]
  - [[#the-git-hooks-section-of-the-makefile][The Git Hooks section of the Makefile]]
  - [[#the-configuration-files-section-of-the-makefile][The Configuration Files section of the Makefile]]
- [[#the-code-quality-section][The Code Quality section]]
  - [[#the-checking-section-of-the-makefile][The Checking section of the Makefile]]
  - [[#the-formatting-section-of-the-makefile][The Formatting section of the Makefile]]
- [[#the-testing-section][The Testing section]]
- [[#the-build-section][The Build section]]
  - [[#the-uv-build-section-of-the-makefile][The UV Build section of the Makefile]]
  - [[#the-docker-build-section-of-the-makefile][The Docker Build section of the Makefile]]
- [[#the-infrastructure-section][The Infrastructure section]]
  - [[#the-docker-compose-section-of-the-makefile][The Docker Compose section of the Makefile]]
  - [[#the-database-migration-section-of-the-makefile][The Database Migration section of the Makefile]]
  - [[#the-fastapi-server-section-of-the-makefile][The FastAPI Server section of the Makefile]]
- [[#the-deployment-section][The Deployment section]]
  - [[#the-flyio-deployment-section-of-the-makefile][The Fly.io Deployment section of the Makefile]]
  - [[#the-rollback-section-of-the-makefile][The Rollback section of the Makefile]]
  - [[#the-build-only-deployment-section-of-the-makefile][The Build-only Deployment section of the Makefile]]
- [[#the-maintenance-section][The Maintenance section]]
  - [[#the-dependency-upgrade-section-of-the-makefile][The Dependency Upgrade section of the Makefile]]
  - [[#the-cleaning-section-of-the-makefile][The Cleaning section of the Makefile]]

* Introduction
:PROPERTIES:
:CUSTOM_ID: h:CDD118FE-59DE-4B59-B919-22DF82087BA1
:CREATED:  [2024-12-28 Sat 11:25]
:END:

Whenever I start a new Python project, I run through a series of
steps to standardize the project's developer experience. This project
is an attempt to short-circuit that, and also to note all the steps
down for my own reference in the future.

To make a change to Metapy's Makefile, edit this file and then
type =C-c C-v C-t= (=M-x org-babel-tangle=) to publish the changes.

* The PHONY section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:207937CB-7D6B-4EA3-AF7A-BE36057F8D89
:CREATED:  [2024-12-28 Sat 11:30]
:END:

A target in a Makefile is meant to be an actual file that the
"execution" of the target creates. Sometimes, we want "actions" as
target -- think =make check= or =make build=, we do not expect a file
called ~check~ or a file called ~build~ to be created. We call these
targets as phony targets, and informing ~make~ helps it avoid checking
for the existence of these files.

Our PHONY targets are as follows:

1. *Environment Setup* (You only need to do this once)
   - =venv= (Creating virtual environment and .env file. See: [[#h:944B86CB-099C-47F9-9F91-DB446EF68012][The Virtual Environment section of the Makefile]])
   - =install-dev-tools= (Installing all development tools. See: [[#h:1438EEBB-FA57-476C-A06E-D4A61EDF2C17][The Development Tools Installation section]])
2. *Code Quality*
   - =check= (Running all quality checks. See: [[#h:7AF49050-665C-4BF6-BC19-97B553F7D0B4][The Checking section of the Makefile]])
   - =format= (Formatting code with ruff. See: [[#h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD][The Formatting section of the Makefile]])
3. *Testing our Python project*
   - =test= (Running unit tests. See: [[#h:CD7913EA-0DCC-4388-BDF5-9DA5AB0C3531][The Testing section]])
   - =test-llm= (Running LLM tests)
   - =test-integration= (Running integration tests)
4. *Building our Python project*
   - =build= (Building deployment artifact. See: [[#h:9EF38A44-B1D5-4357-9DEA-A4BD91202FE5][The UV Build section of the Makefile]])
   - =docker-build= (Building Docker image. See: [[#h:B12DAE81-0591-4E36-B8BA-A73B293FB783][The Docker Build section of the Makefile]])
   - =docker-compose-build= (Building local infrastructure)
5. *Running Infrastructure*
   - =up= (Starting local infrastructure. See: [[#h:287495BE-C413-48D2-86CC-9741B7E3E7E0][The Docker Compose section of the Makefile]])
   - =down= (Stopping local infrastructure)
   - =migrate= (Running database migrations. See: [[#h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E][The Database Migration section of the Makefile]])
   - =server= (Running FastAPI server. See: [[#h:16E6BE64-E940-45CD-AEE7-82D197E6B2DA][The FastAPI Server section of the Makefile]])
6. *Deploying our Python project to Production*
   - =deploy= (Deploying to production with backup. See: [[#h:F4650D06-3125-4FC6-A426-A4B257C86B25][The Fly.io Deployment section of the Makefile]])
   - =rollback= (Rolling back to previous version. See: [[#h:557E00DD-D217-468E-9F20-FE4FE4C049BE][The Rollback section of the Makefile]])
   - =prepare= (Building and uploading image. See: [[#h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD][The Build-only Deployment section of the Makefile]])
7. *Maintenance*
   - =upgrade-libs= (Upgrading dependencies. See: [[#h:9105B76A-A27A-4A63-A2D2-D311CDC9C23E][The Dependency Upgrade section of the Makefile]])
   - =clean= (Cleaning artifacts. See: [[#h:DDEC523F-F4A5-4506-A1DA-3290336D6527][The Cleaning section of the Makefile]])

PHONY targets are declared right above the target itself, for easy maintainability and readability

* The common variables section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:B3833E1E-F328-4DDB-B5CD-31086232DEE2
:CREATED:  [2024-12-28 Sat 11:53]
:END:

These are variables we use in some of the other =Makefile= targets.
You can ignore them for now and we'll review them when we use them.

#+begin_src makefile-bsdmake :tangle "Makefile"
  HOME := $(shell echo $$HOME)
  HERE := $(shell echo $$PWD)
#+end_src

* Set Bash as the shell for executing commands
:PROPERTIES:
:CUSTOM_ID: h:06956487-A480-43D1-94EC-B9148CE6F2D6
:CREATED:  [2024-12-28 Sat 12:04]
:END:

#+begin_src makefile-bsdmake :tangle "Makefile"
  # Set bash instead of sh for the @if [[ conditions,
  # and use the usual safety flags:
  SHELL = /bin/bash -Eeu
#+end_src

* The default goal section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:FA6CC44F-CA8C-4E8B-8613-233C00F5F7EA
:CREATED:  [2024-12-28 Sat 11:55]
:END:

The =.DEFAULT_GOAL= is what runs when we only run the ~make~ command
with no directive. In our case, we want this to print the help options
and exit, so that the user has a clear idea of what is possible with
this Makefile.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .DEFAULT_GOAL := help
#+end_src

* The help target to explain what you can do with the Makefile
:PROPERTIES:
:CUSTOM_ID: h:F4650D06-3125-4FC6-A426-A4B257C86B25
:CREATED:  [2025-01-30 Thu 14:19]
:END:

Here, we use ~awk~ to filter out all the targets which have a
doc-string. This is the "public API" of the Makefile, so to speak.

=/^[a-zA-Z0-9_-]+:.*##/= is a pattern that matches lines starting with
a target name (letters, numbers, underscores, or hyphens) followed by
a colon, followed by ~##~ somewhere in the line. This finds Makefile
target definitions.

In the print command:
- =%-25s= formats the target name left-aligned in 25 characters
- =substr($$1, 1, length($$1)-1)= takes the target name (first field)
  without the trailing colon
- =substr($$0, index($$0,"##")+3)= extracts everything after ## (the
  comment)

#+begin_src makefile-bsdmake :tangle "Makefile"
  .PHONY: help
  help:    ## A brief listing of all available commands
  	@awk '/^[a-zA-Z0-9_-]+:.*##/ { \
  		printf "%-25s # %s\n", \
  		substr($$1, 1, length($$1)-1), \
  		substr($$0, index($$0,"##")+3) \
  	}' $(MAKEFILE_LIST)
#+end_src

* The Environment Setup section
:PROPERTIES:
:CUSTOM_ID: h:1438EEBB-FA57-476C-A06E-D4A61EDF2C17
:CREATED:  [2025-04-20 Sun 19:40]
:END:

In this section, we set up the basic environment needed for a Python
project. This includes creating the necessary configuration files and
directory structure.

** The .env and .env.sample section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:DDEC523F-F4A5-4506-A1DA-3290336D6527
:CREATED:  [2025-01-03 Fri 21:22]
:END:

Environment variables are crucial for Python applications. We create a
=.env.sample= file as a template, and then copy it to =.env= if it
doesn't exist. This follows 12-factor app principles.

#+begin_src makefile-bsdmake :tangle "Makefile"
  .env.sample:
  	touch .env.sample

  .env: .env.sample    ## Copy .env.sample to .env if .env doesn't exist
  	@if [ ! -f .env ]; then \
  		echo "Creating .env from .env.sample..."; \
  		cp .env.sample .env; \
  		echo "âœ“ .env created. Please edit it with your actual values."; \
  	else \
  		echo ".env already exists, skipping..."; \
  	fi
#+end_src

** The pyproject.toml section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:24CF27D2-DAD9-4A3C-B80E-63DF15591FFD
:CREATED:  [2025-01-03 Fri 21:18]
:END:

The =pyproject.toml= file is the modern standard for Python project
configuration. We create a basic template using hatchling as the build
backend, which is simple and reliable.

#+begin_src makefile-bsdmake :tangle "Makefile"
  pyproject.toml:
  	@if [ ! -f pyproject.toml ]; then \
  		echo "Creating pyproject.toml..."; \
  		echo '[build-system]' > pyproject.toml; \
  		echo 'requires = ["hatchling"]' >> pyproject.toml; \
  		echo 'build-backend = "hatchling.build"' >> pyproject.toml; \
  		echo '' >> pyproject.toml; \
  		echo '[project]' >> pyproject.toml; \
  		echo 'name = "metapy"' >> pyproject.toml; \
  		echo 'version = "0.1.0"' >> pyproject.toml; \
  		echo 'description = ""' >> pyproject.toml; \
  		echo 'authors = []' >> pyproject.toml; \
  		echo 'keywords = []' >> pyproject.toml; \
  		echo 'packages = [{include="src"}]' >> pyproject.toml; \
  	    echo 'requires-python = ">=3.14.0"' >> pyproject.toml; \
  		echo '' >> pyproject.toml; \
  	fi
#+end_src

** The Virtual Environment section of the Makefile
:PROPERTIES:
:CUSTOM_ID: h:944B86CB-099C-47F9-9F91-DB446EF68012
:CREATED:  [2024-12-28 Sat 16:40]
:END:

We use UV for fast and reliable Python package management. The =venv=
target creates the virtual environment, sets up the basic directory
structure, and installs dependencies.

#+begin_src makefile-bsdmake :tangle "Makefile"
  tests:
  	mkdir tests

  src:
  	mkdir -p src/metapy && touch src/metapy/__init__.py

  .venv: pyproject.toml tests src
  	uv venv
  	uv lock
  	uv sync --locked --no-cache

  .PHONY: venv
  venv: .venv .env    ## Create the .venv and the .env files
  	@echo "Virtual environment created at .venv/"
#+end_src